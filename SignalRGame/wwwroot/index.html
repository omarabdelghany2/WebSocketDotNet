<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SignalR Game</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
</head>
<body>
    <h1>SignalR Game</h1>
    <input id="userId" placeholder="User ID" />
    <button id="createRoom">Create Room</button>
    <button id="joinRoom">Join Room</button>
    <input id="roomId" placeholder="Room ID" />
    <button id="startGame" disabled>Start Game</button>
    <button id="sendMessage">Send Message</button>
    <input id="message" placeholder="Message" />
    <div id="log"></div>

    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("http://localhost:5274/gamehub") // Update with your server's address
            .withAutomaticReconnect()
            .build();

        let isHost = false;
        let currentRoomId = null;

        // SignalR event handlers
        connection.on("RoomCreated", (roomId) => {
            log(`Room created: ${roomId}`);
            currentRoomId = roomId;
            document.getElementById("startGame").disabled = false; // Enable Start Game button for host
            isHost = true;
        });

        connection.on("PlayerJoined", (playerId) => {
            log(`Player joined: ${playerId}`);
        });

        connection.on("ReceiveMessage", (playerId, message) => {
            log(`${playerId}: ${message}`);
        });

        connection.on("GameStarted", () => {
            log("The game has started!");
        });

        connection.on("RoomDeleted", () => {
            log("The room has been deleted as the host left.");
            disableGameControls();
        });

        connection.on("Error", (message) => {
            log(`Error: ${message}`);
        });

        connection.start()
            .then(() => log("Connected to SignalR"))
            .catch(err => log(`Error: ${err}`));

        // Button click handlers
        document.getElementById("createRoom").onclick = async () => {
            const userId = document.getElementById("userId").value.trim();
            if (!userId) {
                log("Please enter a User ID.");
                return;
            }

            try {
                const roomId = await connection.invoke("CreateRoom", userId);
                if (roomId) {
                    log(`Room created with ID: ${roomId}`);
                    currentRoomId = roomId;
                    document.getElementById("startGame").disabled = false; // Enable Start Game button for host
                    isHost = true;
                }
            } catch (err) {
                log(`Error: ${err}`);
            }
        };

        document.getElementById("joinRoom").onclick = () => {
            const userId = document.getElementById("userId").value.trim();
            const roomId = document.getElementById("roomId").value.trim();

            if (!userId || !roomId) {
                log("Please enter both User ID and Room ID.");
                return;
            }

            connection.invoke("JoinRoom", roomId, userId)
                .then(() => {
                    log(`Joined room: ${roomId}`);
                    currentRoomId = roomId;
                })
                .catch(err => log(`Error: ${err}`));
        };

        document.getElementById("startGame").onclick = () => {
            const userId = document.getElementById("userId").value.trim();
            if (!isHost || !currentRoomId) {
                log("Only the host can start the game.");
                return;
            }

            connection.invoke("StartGame", currentRoomId, userId)
                .catch(err => log(`Error: ${err}`));
        };

        document.getElementById("sendMessage").onclick = () => {
            const userId = document.getElementById("userId").value.trim();
            const message = document.getElementById("message").value.trim();

            if (!currentRoomId || !userId || !message) {
                log("Please ensure you're in a room and have entered a message.");
                return;
            }

            connection.invoke("SendMessageToRoom", currentRoomId, userId, message)
                .catch(err => log(`Error: ${err}`));
        };

        // Utility function to log messages
        function log(message) {
            const logDiv = document.getElementById("log");
            const p = document.createElement("p");
            p.textContent = message;
            logDiv.appendChild(p);
        }

        // Disable controls if the host leaves
        function disableGameControls() {
            document.getElementById("startGame").disabled = true;
            isHost = false;
            currentRoomId = null;
        }
    </script>
</body>
</html>
